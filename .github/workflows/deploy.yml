# Deploy to npm on release tags
name: Deploy to NPM

on:
    push:
        # Sequence of patterns matched against refs/tags
        tags:
            - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
            - name: Install dependencies
              run: npm ci
            - name: Running tests
              run: npm test

    create-release:
        name: Create Release
        needs: test
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')
        permissions:
            contents: write
            id-token: write
        steps:
            - uses: actions/checkout@v4
            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
              with:
                  tag_name: ${{ github.ref }}
                  release_name: Release ${{ github.ref }}
                  body: |
                      Changes in this Release
                      - First Change
                      - Second Change
                  draft: false
                  prerelease: false

    publish-npm:
        name: Publish to NPM
        needs: create-release
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')
        permissions:
            contents: read
            id-token: write
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  registry-url: https://registry.npmjs.org/
            - name: Install dependencies
              run: npm ci
            - name: Build package
              run: npm run npmjs
            - name: Verify build
              run: test -f ./dist/package.json
            - name: Publish to npm
              run: npm publish ./dist --provenance
              env:
                  NODE_AUTH_TOKEN: ${{secrets.npm_token}}

    # publish-jsr:
    #     needs: test
    #     runs-on: ubuntu-latest
    #     permissions:
    #         contents: read
    #         id-token: write
    #     steps:
    #         - uses: actions/checkout@v4
    #         - name: Publish package
    #           run: npx jsr publish --allow-slow-types
